{
  "version": 3,
  "sources": ["../src/system.ts", "../src/effect.ts", "../src/ref.ts", "../../shared/src/index.ts", "../src/reactive.ts"],
  "sourcesContent": ["import { ReactiveEffect } from './effect'\r\nimport { RefImpl } from './ref'\r\n\r\ninterface Dep {\r\n  subs: Link | undefined\r\n  subsTail: Link | undefined\r\n}\r\ninterface Sub {\r\n  deps: Link | undefined\r\n  depsTail: Link | undefined\r\n}\r\n\r\nlet linkPool: Link\r\nexport interface Link {\r\n  sub: Sub\r\n  nextSub: Link | undefined\r\n  prevSub: Link | undefined\r\n  dep: Dep\r\n  nextDep: Link | undefined\r\n}\r\nexport function propagate(subs: Link) {\r\n  let link = subs\r\n  const queuedEffect = []\r\n  while (link) {\r\n    const sub = link.sub as ReactiveEffect\r\n    if (!sub.tracking) {\r\n      queuedEffect.push(sub)\r\n    }\r\n    link = link.nextSub\r\n  }\r\n  queuedEffect.forEach(effect => effect.notify())\r\n}\r\n\r\nexport function link(dep: RefImpl, sub: ReactiveEffect) {\r\n  const nextDep = sub.depsTail === undefined ? sub.deps : sub.depsTail.nextDep\r\n  if (nextDep && nextDep.dep === dep) {\r\n    sub.depsTail = nextDep\r\n    return\r\n  }\r\n  let newLink: Link\r\n  if (linkPool) {\r\n    newLink = linkPool\r\n    linkPool = linkPool.nextDep\r\n    newLink.sub = sub\r\n    newLink.dep = dep\r\n    newLink.nextDep = nextDep\r\n  } else {\r\n    newLink = {\r\n      sub,\r\n      dep,\r\n      nextDep,\r\n      nextSub: undefined,\r\n      prevSub: undefined,\r\n    }\r\n  }\r\n\r\n  if (!dep.subsTail) {\r\n    dep.subs = newLink\r\n    dep.subsTail = newLink\r\n  } else {\r\n    dep.subsTail.nextSub = newLink\r\n    newLink.prevSub = dep.subsTail\r\n    dep.subsTail = newLink\r\n  }\r\n\r\n  if (sub.depsTail) {\r\n    sub.depsTail.nextDep = newLink\r\n    sub.depsTail = newLink\r\n  } else {\r\n    sub.deps = newLink\r\n    sub.depsTail = newLink\r\n  }\r\n}\r\n\r\nexport function startTrack(sub: ReactiveEffect) {\r\n  sub.tracking = true\r\n  sub.depsTail = undefined\r\n}\r\n\r\nexport function endTrack(sub: ReactiveEffect) {\r\n  sub.tracking = false\r\n  const depsTail = sub.depsTail\r\n  if (depsTail) {\r\n    if (depsTail.nextDep) {\r\n      clearTracking(depsTail.nextDep)\r\n      depsTail.nextDep = undefined\r\n    }\r\n  } else if (sub.deps) {\r\n    clearTracking(sub.deps)\r\n    sub.deps = undefined\r\n  }\r\n}\r\n\r\nexport function clearTracking(link: Link) {\r\n  while (link) {\r\n    const { prevSub, nextSub, nextDep, dep } = link\r\n\r\n    /**\r\n     * \u5982\u679C prevSub \u6709\uFF0C\u90A3\u5C31\u628A prevSub \u7684\u4E0B\u4E00\u4E2A\u8282\u70B9\uFF0C\u6307\u5411\u5F53\u524D\u8282\u70B9\u7684\u4E0B\u4E00\u4E2A\r\n     * \u5982\u679C\u6CA1\u6709\uFF0C\u90A3\u5C31\u662F\u5934\u8282\u70B9\uFF0C\u90A3\u5C31\u628A dep.subs \u6307\u5411\u5F53\u524D\u8282\u70B9\u7684\u4E0B\u4E00\u4E2A\r\n     */\r\n    debugger\r\n    if (prevSub) {\r\n      prevSub.nextSub = nextSub\r\n      link.nextSub = undefined\r\n    } else {\r\n      if (dep) {\r\n        dep.subs = nextSub\r\n      }\r\n    }\r\n\r\n    /**\r\n     * \u5982\u679C\u4E0B\u4E00\u4E2A\u6709\uFF0C\u90A3\u5C31\u628A nextSub \u7684\u4E0A\u4E00\u4E2A\u8282\u70B9\uFF0C\u6307\u5411\u5F53\u524D\u8282\u70B9\u7684\u4E0A\u4E00\u4E2A\u8282\u70B9\r\n     * \u5982\u679C\u4E0B\u4E00\u4E2A\u6CA1\u6709\uFF0C\u90A3\u5B83\u5C31\u662F\u5C3E\u8282\u70B9\uFF0C\u628A dep.depsTail \u53EA\u60F3\u4E0A\u4E00\u4E2A\u8282\u70B9\r\n     */\r\n    if (nextSub) {\r\n      nextSub.prevSub = prevSub\r\n      link.prevSub = undefined\r\n    } else {\r\n      if (dep) {\r\n        dep.subsTail = prevSub\r\n      }\r\n    }\r\n\r\n    link.dep = link.sub = undefined\r\n\r\n    /**\r\n     * \u628A\u4E0D\u8981\u7684\u8282\u70B9\u7ED9 linkPool\uFF0C\u8BA9\u5B83\u53BB\u590D\u7528\u5427\r\n     */\r\n    link.nextDep = linkPool\r\n    linkPool = link\r\n\r\n    link = nextDep\r\n  }\r\n}\r\n", "import { endTrack, Link, startTrack } from './system'\r\n\r\nexport let activeSub\r\n\r\nexport class ReactiveEffect {\r\n  deps: Link | undefined\r\n  depsTail: Link | undefined\r\n  tracking = false\r\n  constructor(public fn: Function) {}\r\n  run() {\r\n    const prevSub = activeSub\r\n    activeSub = this\r\n    startTrack(this)\r\n    try {\r\n      return this.fn()\r\n    } finally {\r\n      endTrack(this)\r\n      activeSub = prevSub\r\n    }\r\n  }\r\n\r\n  scheduler() {\r\n    this.run()\r\n  }\r\n  notify() {\r\n    this.scheduler()\r\n  }\r\n}\r\n\r\nexport function effect(fn: Function, options?: any) {\r\n  const e = new ReactiveEffect(fn)\r\n  Object.assign(e, options)\r\n  e.run()\r\n\r\n  const runner = () => e.run()\r\n  runner.effect = e\r\n  return runner\r\n}\r\n", "import { activeSub } from './effect'\r\nimport { link, propagate, Link } from './system'\r\n\r\nenum ReactivityFlags {\r\n  IS_REF = '__v_isRef',\r\n}\r\n\r\nexport class RefImpl {\r\n  _value;\r\n\r\n  [ReactivityFlags.IS_REF] = true\r\n\r\n  subs: Link\r\n  subsTail: Link\r\n  constructor(value: any) {\r\n    this._value = value\r\n  }\r\n\r\n  get value() {\r\n    trackRef(this)\r\n\r\n    return this._value\r\n  }\r\n\r\n  set value(newValue: any) {\r\n    this._value = newValue\r\n    trigerRef(this)\r\n  }\r\n}\r\n\r\nexport function ref(value: any) {\r\n  return new RefImpl(value)\r\n}\r\n\r\nexport function isRef(value: any): boolean {\r\n  return !!(value && value[ReactivityFlags.IS_REF])\r\n}\r\n\r\nexport function trackRef(dep: RefImpl) {\r\n  if (activeSub) {\r\n    link(dep, activeSub)\r\n  }\r\n}\r\n\r\nexport function trigerRef(dep: RefImpl) {\r\n  if (dep.subs) {\r\n    propagate(dep.subs)\r\n  }\r\n}\r\n", "export function isObject(value: any): boolean {\r\n  return value !== null && typeof value === 'object'\r\n}\r\n", "import { isObject } from '@vue/shared'\r\n\r\nexport function reactive<T extends object>(target: T) {\r\n  return createReactiveObject(target)\r\n}\r\nfunction createReactiveObject<T extends object>(target: T) {\r\n  if (!isObject(target)) {\r\n    return target\r\n  }\r\n\r\n  const proxy = new Proxy(target, {\r\n    get(target, key, receiver) {},\r\n    set(target, key, value, receiver) {},\r\n  })\r\n}\r\n"],
  "mappings": ";AAYA,IAAI;AAQG,SAAS,UAAU,MAAY;AACpC,MAAIA,QAAO;AACX,QAAM,eAAe,CAAC;AACtB,SAAOA,OAAM;AACX,UAAM,MAAMA,MAAK;AACjB,QAAI,CAAC,IAAI,UAAU;AACjB,mBAAa,KAAK,GAAG;AAAA,IACvB;AACA,IAAAA,QAAOA,MAAK;AAAA,EACd;AACA,eAAa,QAAQ,CAAAC,YAAUA,QAAO,OAAO,CAAC;AAChD;AAEO,SAAS,KAAK,KAAc,KAAqB;AACtD,QAAM,UAAU,IAAI,aAAa,SAAY,IAAI,OAAO,IAAI,SAAS;AACrE,MAAI,WAAW,QAAQ,QAAQ,KAAK;AAClC,QAAI,WAAW;AACf;AAAA,EACF;AACA,MAAI;AACJ,MAAI,UAAU;AACZ,cAAU;AACV,eAAW,SAAS;AACpB,YAAQ,MAAM;AACd,YAAQ,MAAM;AACd,YAAQ,UAAU;AAAA,EACpB,OAAO;AACL,cAAU;AAAA,MACR;AAAA,MACA;AAAA,MACA;AAAA,MACA,SAAS;AAAA,MACT,SAAS;AAAA,IACX;AAAA,EACF;AAEA,MAAI,CAAC,IAAI,UAAU;AACjB,QAAI,OAAO;AACX,QAAI,WAAW;AAAA,EACjB,OAAO;AACL,QAAI,SAAS,UAAU;AACvB,YAAQ,UAAU,IAAI;AACtB,QAAI,WAAW;AAAA,EACjB;AAEA,MAAI,IAAI,UAAU;AAChB,QAAI,SAAS,UAAU;AACvB,QAAI,WAAW;AAAA,EACjB,OAAO;AACL,QAAI,OAAO;AACX,QAAI,WAAW;AAAA,EACjB;AACF;AAEO,SAAS,WAAW,KAAqB;AAC9C,MAAI,WAAW;AACf,MAAI,WAAW;AACjB;AAEO,SAAS,SAAS,KAAqB;AAC5C,MAAI,WAAW;AACf,QAAM,WAAW,IAAI;AACrB,MAAI,UAAU;AACZ,QAAI,SAAS,SAAS;AACpB,oBAAc,SAAS,OAAO;AAC9B,eAAS,UAAU;AAAA,IACrB;AAAA,EACF,WAAW,IAAI,MAAM;AACnB,kBAAc,IAAI,IAAI;AACtB,QAAI,OAAO;AAAA,EACb;AACF;AAEO,SAAS,cAAcD,OAAY;AACxC,SAAOA,OAAM;AACX,UAAM,EAAE,SAAS,SAAS,SAAS,IAAI,IAAIA;AAM3C;AACA,QAAI,SAAS;AACX,cAAQ,UAAU;AAClB,MAAAA,MAAK,UAAU;AAAA,IACjB,OAAO;AACL,UAAI,KAAK;AACP,YAAI,OAAO;AAAA,MACb;AAAA,IACF;AAMA,QAAI,SAAS;AACX,cAAQ,UAAU;AAClB,MAAAA,MAAK,UAAU;AAAA,IACjB,OAAO;AACL,UAAI,KAAK;AACP,YAAI,WAAW;AAAA,MACjB;AAAA,IACF;AAEA,IAAAA,MAAK,MAAMA,MAAK,MAAM;AAKtB,IAAAA,MAAK,UAAU;AACf,eAAWA;AAEX,IAAAA,QAAO;AAAA,EACT;AACF;;;ACpIO,IAAI;AAEJ,IAAM,iBAAN,MAAqB;AAAA,EAI1B,YAAmB,IAAc;AAAd;AAAA,EAAe;AAAA,EAHlC;AAAA,EACA;AAAA,EACA,WAAW;AAAA,EAEX,MAAM;AACJ,UAAM,UAAU;AAChB,gBAAY;AACZ,eAAW,IAAI;AACf,QAAI;AACF,aAAO,KAAK,GAAG;AAAA,IACjB,UAAE;AACA,eAAS,IAAI;AACb,kBAAY;AAAA,IACd;AAAA,EACF;AAAA,EAEA,YAAY;AACV,SAAK,IAAI;AAAA,EACX;AAAA,EACA,SAAS;AACP,SAAK,UAAU;AAAA,EACjB;AACF;AAEO,SAAS,OAAO,IAAc,SAAe;AAClD,QAAM,IAAI,IAAI,eAAe,EAAE;AAC/B,SAAO,OAAO,GAAG,OAAO;AACxB,IAAE,IAAI;AAEN,QAAM,SAAS,MAAM,EAAE,IAAI;AAC3B,SAAO,SAAS;AAChB,SAAO;AACT;;;AC9BO,IAAM,UAAN,MAAc;AAAA,EACnB;AAAA,EAEA,CAAC,wBAAsB,IAAI;AAAA,EAE3B;AAAA,EACA;AAAA,EACA,YAAY,OAAY;AACtB,SAAK,SAAS;AAAA,EAChB;AAAA,EAEA,IAAI,QAAQ;AACV,aAAS,IAAI;AAEb,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,MAAM,UAAe;AACvB,SAAK,SAAS;AACd,cAAU,IAAI;AAAA,EAChB;AACF;AAEO,SAAS,IAAI,OAAY;AAC9B,SAAO,IAAI,QAAQ,KAAK;AAC1B;AAEO,SAAS,MAAM,OAAqB;AACzC,SAAO,CAAC,EAAE,SAAS,MAAM,wBAAsB;AACjD;AAEO,SAAS,SAAS,KAAc;AACrC,MAAI,WAAW;AACb,SAAK,KAAK,SAAS;AAAA,EACrB;AACF;AAEO,SAAS,UAAU,KAAc;AACtC,MAAI,IAAI,MAAM;AACZ,cAAU,IAAI,IAAI;AAAA,EACpB;AACF;;;AChDO,SAAS,SAAS,OAAqB;AAC5C,SAAO,UAAU,QAAQ,OAAO,UAAU;AAC5C;;;ACAO,SAAS,SAA2B,QAAW;AACpD,SAAO,qBAAqB,MAAM;AACpC;AACA,SAAS,qBAAuC,QAAW;AACzD,MAAI,CAAC,SAAS,MAAM,GAAG;AACrB,WAAO;AAAA,EACT;AAEA,QAAM,QAAQ,IAAI,MAAM,QAAQ;AAAA,IAC9B,IAAIE,SAAQ,KAAK,UAAU;AAAA,IAAC;AAAA,IAC5B,IAAIA,SAAQ,KAAK,OAAO,UAAU;AAAA,IAAC;AAAA,EACrC,CAAC;AACH;",
  "names": ["link", "effect", "target"]
}
